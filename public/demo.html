<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UG JS SDK Demo</title>
  <link href="assets/images/favicon.svg" rel="shortcut icon" type="image/x-icon">
  <link rel="stylesheet" href="demo.css">
</head>
<body>
  <h1>UG JS SDK Demo</h1>
  <div class="callout">
    <p>Please login to <a href="https://pug-playground.stg.uglabs.app/" target="_blank">https://pug-playground.stg.uglabs.app/</a> and:</p>
    <p>1. Create a <a href="https://pug-playground.stg.uglabs.app/service-accounts" target="_blank">Service account</a> and "Copy" the API Key.</p>
    <p>2. Create a <a href="https://pug-playground.stg.uglabs.app/players" target="_blank">Player</a> and copy the "Federated Id" (Player's secret)</p>
    </p>
  </div>
  <label for="apiKey">API Key:</label>
  <input type="text" id="apiKey" placeholder="Enter Service Account API Key" style="width: 300px;">
  <br>
  <label for="federatedId">Federated Id:</label>
  <input type="text" id="federatedId" placeholder="Enter Federated Id" style="width: 300px;">
  <br>
  <label for="serverUrlInput">API URL:</label>
  <input type="text" id="serverUrlInput" placeholder="Override Server URL" style="width: 300px;">
  <span class="hint-text"> (no need to modify)</span>
  <br>
  <label for="promptInput">Prompt:</label>
  <br>
  <textarea id="promptInput" rows="4"></textarea>
  <br><br>
  <button id="startButton">Start</button>
  <button id="stopButton" disabled>Stop</button>
  <br><br>
  <input type="text" id="textInput" placeholder="Enter text to send" />
  <button id="sendButton" disabled>Send</button>
  <br><br>
  <div id="errorMessage" class="error-message"></div>
  <div>State: <span id="state">uninitialized</span></div>
  <div>Text: <span id="text"></span></div>

  <script src="dist/ug-js-sdk-bundle.js"></script>
  <script>
    const DEFAULT_UG_SERVER_URL = 'https://pug.stg.uglabs.app/api/';
    
    const playbackCapabilities = {
      audio: false, // This demo is text only
      viseme: false, // Unused
      subtitles: true,
      avatar: false,
    }
    const inputCapabilities = {
      audio: false,
      text: true,
    }
    const hooks = {
      onTextMessage: (event) => {
        console.log('Text message received:', event);
        document.getElementById('text').textContent += event.text;
      },
      onStateChange: (state) => {
        console.log('State changed:', state);
        document.getElementById('state').textContent = state;
        if(state !== "uninitialized") {
          sendButton.disabled = false;
          startButton.disabled = true;
          stopButton.disabled = false;
        }
      },
      onSubtitleChange: (event) => {
        console.log('Subtitle changed:', event);
        // document.getElementById('subtitle').textContent = event.subtitle;
      },
      onError: (error) => {
        console.error('Conversation error:', error);
        displayError(error.message || 'An unknown error occurred.');
      },
    };

    
    const state = document.getElementById('state');
    const apiKeyInput = document.getElementById('apiKey');
    const federatedIdInput = document.getElementById('federatedId');
    const serverUrlInput = document.getElementById('serverUrlInput');
    serverUrlInput.value = DEFAULT_UG_SERVER_URL; // Set default value
    const promptInput = document.getElementById('promptInput');
    promptInput.value = "a game of Scattergories where the user needs to say a country that starts with the letter C. for example - user can guess Canada";
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const textInput = document.getElementById('textInput');
    // Allow pressing Enter in the text input to trigger the send button
    textInput.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        sendButton.click();
      }
    });
    const sendButton = document.getElementById('sendButton');
    const stateDiv = document.getElementById('state');
    const textDiv = document.getElementById('text');
    const errorMessageDiv = document.getElementById('errorMessage');

    // Load keys from local storage
    const savedApiKey = localStorage.getItem('apiKey');
    if (savedApiKey) {
      apiKeyInput.value = savedApiKey;
    }
    const savedFederatedId = localStorage.getItem('federatedId');
    if (savedFederatedId) {
      federatedIdInput.value = savedFederatedId;
    }


    let conversationManager;

    function displayError(message) {
      errorMessageDiv.textContent = message;
      errorMessageDiv.style.display = 'block';
    }

    function clearError() {
      errorMessageDiv.textContent = '';
      errorMessageDiv.style.display = 'none';
    }

    // A wrapper to handle async actions and display errors.
    async function handleAction(action) {
      clearError();
      try {
        await action();
      } catch (error) {
        console.error(error);
        displayError(error.message || error);
      }
    }

    startButton.addEventListener('click', async () => {
      document.getElementById('text').textContent = ''; // Clear previous text

      // Save keys to local storage
      if (apiKeyInput.value) {
        localStorage.setItem('apiKey', apiKeyInput.value);
      }
      if (federatedIdInput.value) {
        localStorage.setItem('federatedId', federatedIdInput.value);
      }
      const config = {
        capabilities: playbackCapabilities,
        inputCapabilities: inputCapabilities,
        apiUrl: serverUrlInput.value || DEFAULT_UG_SERVER_URL,
        apiKey: apiKeyInput.value,
        federatedId: federatedIdInput.value,
        prompt: promptInput.value,
        hooks: hooks,
      };

      conversationManager = new uglabs.ConversationManager(config);

      await handleAction(async () => {
        await conversationManager.initialize();
        await conversationManager.startListening();
      });
    });

    stopButton.addEventListener('click', async () => {
      if (!conversationManager) return;
      await handleAction(() => conversationManager.stop());
    });

    sendButton.addEventListener('click', async () => {
      if (!conversationManager) return;
      await handleAction(async () => {
        document.getElementById('text').textContent = "";
        await conversationManager.sendText(textInput.value);
        textInput.value = '';
      });
    });
  </script>
</body>
</html>